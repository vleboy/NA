<template>
  <div class="gamelist">
    <div class="gametab">
      <div class="tabcard-left">
        <el-button class="" @click="getAlllist">全部游戏</el-button>
        <el-button class="" v-for="item in companyList" :key="item" @click="getCompanyGame(item.server)">{{item.client}}</el-button>
        <div style="margin:1rem 0 0 7.2rem">
          <el-button  v-for="item in companyGame" :key="item" @click="getDetailGame(item.code)">{{item.name}}</el-button>
        </div>
      </div>
      <div class="tabcard-right">
        <el-input placeholder="请输入关键词" class="input" v-model="searchGameName"></el-input>
        <el-button class="gamesearch" type="primary" @click="searchGame">搜索</el-button>
        <el-button @click="resetGamelist">重置</el-button>
      </div>
    </div>
    <p class="backinfocount">共搜索到 {{count}} 条数据</p>
    <div class="cardlist">
      <el-row>
        <el-col v-for="(o, index) in allgames" :key="o" class="card" :span="7">
            <div class="card-top">
              <img :src="o.gameImg" alt="游戏缩略图">
              <p class="p1">游戏名称: {{o.gameName}}</p>
              <p class="p2" :title="o.gameRecommend">游戏简介: {{o.gameRecommend}}</p>
              <p class="p3" v-if="o.gameType === '0'">游戏类型：棋牌游戏</p>
              <p class="p3" v-if="o.gameType === '1'">游戏类型：电子游戏</p>
              <p class="p3" v-if="o.gameType === '2'">游戏类型：真人视讯</p>
            </div>
            <div class="card-bottom">
              <span>
                  <span class="statu1" v-if="o.gameStatus === 1">&bull;</span>
                  <span class="statu2" v-if="o.gameStatus === 0">&bull;</span>
                  <span class="subscribe1" v-if="o.gameStatus === 1">在线</span>
                  <span class="subscribe2" v-if="o.gameStatus === 0">离线</span>
                  <span class="time">{{formatTime(o.updatedAt)}}</span>
              </span>
                <el-dropdown trigger="click" class="moreIcon" v-if="loginRole == '1'">
                <span class="el-dropdown-link"><i class="el-icon-more"></i></span>
                  <el-dropdown-menu slot="dropdown">
                      <p @click="onlineGame(o)" v-if="o.gameStatus !== 1"><el-dropdown-item>上线</el-dropdown-item></p>
                      <p @click="offlineGame(o)" v-if="o.gameStatus === 1"><el-dropdown-item>下线</el-dropdown-item></p>
                  </el-dropdown-menu>
              </el-dropdown>
            </div>
        </el-col>
      </el-row>
    </div>
    </div>
  </div>
</template>
<script>
import { detailTime } from '@/behavior/format'
import { invoke } from '@/libs/fetchLib'
import api from '@/api/api'
export default {
  beforeCreate () {
    localStorage.removeItem('clickGameType')
    this.$store.commit('startLoading')
    this.$store.commit('resetAjax')
    this.$store.commit({
      type: 'recordNowindex',
      data: 'gamelist'
    })
    this.$store.commit({
      type: 'recordCompanyGame',
      data: []
    })
    this.$store.commit('returnLocalStorage')
    this.$store.dispatch('getAllGameList')
  },
  computed: {
    ajaxCount () {
      return this.$store.state.ajaxCount
    },
    companyList () {
      return this.$store.state.variable.companyList
    },
    companyGame () {
      return this.$store.state.variable.companyGame
    },
    allgames () {
      return this.$store.state.variable.allgames
    },
    count () {
      return this.$store.state.variable.allgames.length
    }
  },
  mounted () {
  },
  data () {
    return {
      loginRole: localStorage.loginRole,
      searchGameName: ''
    }
  },
  methods: {
    searchGame () {
      if (!this.searchGameName) {
        this.$message({
          message: '请输入关键词',
          type: 'error'
        })
      } else {
        var data = {
          gameType: null,
          keyword: this.searchGameName
        }
        invoke({
          url: api.gameList,
          method: api.post,
          data: data
        }).then(
          result => {
            const [err, ret] = result
            if (err) {
              this.$message({
                message: '未找到该游戏',
                type: 'error'
              })
            } else {
              var data = ret.data.payload
              this.$store.commit('resetAllGameList')
              this.$store.commit({
                type: 'recordAllGameList',
                data: data
              })
              this.$store.commit('closeLoading')
            }
          }
        )
      }
    }, // 搜索游戏
    resetGamelist () {
      this.searchGameName = ''
      localStorage.removeItem('clickGameType')
      this.$store.commit('startLoading')
      this.$store.commit({
        type: 'recordCompanyGame',
        data: []
      })
      this.$store.dispatch('getAllGameList')
    }, // 重置游戏列表
    formatTime (time) {
      return detailTime(time)
    },
    getCompanyGame (data) {
      localStorage.setItem('nowCompany', data)
      this.$store.dispatch('getCompanyGame')
    }, // 请求该运营商游戏大类
    getAlllist () {
      localStorage.removeItem('clickGameType')
      this.$store.commit('startLoading')
      this.$store.dispatch('getAllGameList')
    }, // 请求所有游戏
    getDetailGame (data) {
      this.$store.commit('startLoading')
      var focus = {
        gameType: data
      }
      localStorage.setItem('clickGameType', data)
      invoke({
        url: api.gameList,
        method: api.post,
        data: focus
      }).then(
        result => {
          const [err, ret] = result
          if (err) {
          } else {
            var list = ret.data.payload
            this.$store.commit('resetAllGameList')
            this.$store.commit({
              type: 'recordAllGameList',
              data: list
            })
            this.$store.commit('closeLoading')
          }
        }
      )
    }, // 请求该运营商游戏大类下的游戏
    getnowlist (code) {
      this.searchGameName = ''
      var data = {
        gameType: code
      }
      localStorage.setItem('clickGameType', code)
      invoke({
        url: api.gameList,
        method: api.post,
        data: data
      }).then(
        result => {
          const [err, ret] = result
          if (err) {
          } else {
            var list = ret.data.payload
            this.$store.commit('resetAllGameList')
            this.$store.commit({
              type: 'recordAllGameList',
              data: list
            })
            this.$store.commit('closeLoading')
          }
        }
      )
    }, // 获取当前类型游戏
    onlineGame (o) {
      this.$store.commit('startLoading')
      var data = {
        gameType: o.gameType,
        gameId: o.gameId,
        status: '1'
      }
      invoke({
        url: api.changeGame,
        method: api.post,
        data: data
      }).then(
        result => {
          const [err, ret] = result
          if (err) {
            this.$message({
              message: err.msg,
              type: 'error'
            })
          } else {
            var data = ret.data.payload
            if (this.searchGameName) {
              this.searchGame()
            }
            if (localStorage.clickGameType && !this.searchGameName) {
              this.getnowlist(localStorage.clickGameType)
            }
            if (!this.searchGameName && !localStorage.clickGameType) {
              this.$store.dispatch('getAllGameList')
            }
            this.$message({
              message: '操作成功',
              type: 'success'
            })
          }
        }
      )
    }, // 上线游戏
    offlineGame (o) {
      this.$store.commit('startLoading')
      var data = {
        gameType: o.gameType,
        gameId: o.gameId,
        status: '0'
      }
      invoke({
        url: api.changeGame,
        method: api.post,
        data: data
      }).then(
        result => {
          const [err, ret] = result
          if (err) {
            this.$message({
              message: err.msg,
              type: 'error'
            })
          } else {
            var data = ret.data.payload
            if (this.searchGameName) {
              this.searchGame()
            }
            if (localStorage.clickGameType && !this.searchGameName) {
              this.getnowlist(localStorage.clickGameType)
            }
            if (!this.searchGameName && !localStorage.clickGameType) {
              this.$store.dispatch('getAllGameList')
            }
            this.$message({
              message: '操作成功',
              type: 'success'
            })
          }
        }
      )
    } // 下线游戏
  },
  beforeDestory () {
    localStorage.removeItem('clickGameType')
  }
}
</script>

<style scpoed>

.gamelist .gametab{background-color: #f5f5f5;padding: 2rem;min-height: 6rem;margin-top: 1rem}
.gamelist .input{width: 18rem;}
.gamelist .tabcard:after{clear:both;content:'.';display:block;width: 0;height: 0;visibility:hidden;}
.gamelist .tabcard-left{float: left;}
.gamelist .tabcard-right{float: right;}

.gamelist .cardlist{margin-bottom: 1rem}

.gamelist .backinfocount{margin-top: 1rem;margin-left: 2rem}

.gamelist .card{display: inline-block;width: 32%;margin-left: 1rem;margin-top: 1rem;padding: 0;border:1px solid #919191;border-radius: 0.4rem;padding:1rem}
.gamelist .card-top{border-bottom: 1px solid #bfbfbf;}
.gamelist .card-top:after{clear:both;content:'.';display:block;width: 0;height: 0;visibility:hidden;}
.gamelist .card-top img{display: inline-block;width: 30%;height: 8rem;float: left;margin-bottom: 1rem}
.gamelist .card-top p{float: left;width: 50%;margin-left: 1.5rem}
.gamelist .card-top .p1{font-size: 1rem}
.gamelist .card-top .p2{font-size: 0.8rem;margin-top: 0.5rem;color: #919191;max-width: 80%;overflow: hidden;text-overflow:ellipsis;white-space: nowrap;}

.gamelist .card-bottom{padding-top: 1rem;padding-bottom: 0.5rem}

.gamelist .moreIcon{float: right;}
.gamelist .editIcon{float: right;margin-right: 1rem}
.gamelist i{color: gray;float: right;font-size: 1.2rem;margin-top: 0.75rem}

.gamelist .statu1{color: #0ECA5B;font-size: 1.5rem;vertical-align: -0.15rem;} /*在线状态*/
.gamelist .statu2{color: #919191;font-size: 1.5rem;vertical-align: -0.15rem;} /*离线状态*/
.gamelist .statu3{color: #ffbf00;font-size: 1.5rem;vertical-align: -0.15rem;} /*维护状态*/
.gamelist .statu4{color: red;font-size: 1.5rem;vertical-align: -0.15rem;} /*故障状态*/

.gamelist .subscribe1{color: #0ECA5B;font-size: 1rem}
.gamelist .subscribe2{color: #919191;font-size: 1rem}
.gamelist .subscribe3{color: #ffbf00;font-size: 1rem}
.gamelist .subscribe4{color: red;font-size: 1rem}

.gamelist .time{font-size: 0.85rem;color: #919191;margin-left: 0.2rem}
</style>
